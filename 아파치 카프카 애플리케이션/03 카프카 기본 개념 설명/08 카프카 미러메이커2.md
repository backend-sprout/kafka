# 카프카 미러메이커2

카프카 미러메이커2는 **서로 다른 2개의 `카프카 클러스터` 간에 토픽을 복제하는 애플리케이션이다.**        
     
프로듀서와 컨슈머를 사용해서 직접 미러링하는 애플리케이션을 만들면 되지만, 굳이 미러메이커를 사용하는 이유는?  
* 토픽의 모든 것을 복제할 필요성이 있기 때문이다.    
    
토픽에 있는 레코드는 **고유한** '메시지 키', '메시지 값', '파티션'을 가진다.         
프로듀서와 컨슈머를 사용해서 2개의 서로 다른 클러스터에 토픽의 데이터를 완전히 동일하게 옮기는 것은 어려운 작업이다.    
  
* **동일한 파티션에 동일한 레코드가 들어가도록 하는 작업 :** **복제하기 전 클러스터에서 사용하던 파티셔너에 대한 정보 없이는 불가능하다.**    
* **복제하는 토픽의 파티션 개수가 달라진다면 :** 복제된 데이터를 저장하는 토픽의 파티션도 개수가 달라져야하므로 어드민까지 조합한 형태로 개발이 필요  
    
이 모든 기능을 지원하는 것이 바로 미러메이커2이다.    

## 미러메이커1 
미러메이커1 은 레거십 버전의 미러메이커로 카프카에서 제공하는 최초의 토픽 데이터 복제 기능을 가진 애플리케이션이다.  
하지만, 미러메이커1은 토픽 복제에 충분한 기능을 가지고 있지 않았다.   

* 토픽의 데이터를 복제할 때 기본 파티셔너를 사용했기 때문에 복제하기 전 데이터와 복제된 데이터의 파티션 정보가 달랐다.   
* 복제하는 토픽이 달라지면 수정하기 위해서 미러메이커 애플리케이션을 재시작해야했다.      
* 정확히 한번 전달을 보장하지 못했기 때문에 복제하는 데이터의 유실 또는 중복이 발생할 가능성이 있었다.     
* 카프카 클러스터의 양방향 토픽 복제도 지원하지 못했다.    
  
미러메이커1이 가지고 있는 토픽 복제 기능은 클러스터간 토픽의 완벽한 복제라는 목표를 달성하지 못했고 개선이 필요했다.      
그러던 중 2019년 말에 카프카 2.4.0출시와 함께 기존 미러메이커1의 기능을 개선한 미러메이커2를 발표하였다.   
미러메이커2는 미러메이커1이 가지던 단점을 해소하였고    
토픽의 데이터를 복제할 뿐만 아니라 토픽 설정까지도 복제하여 파티션의 변화, 토픽 설정값의 변화도 동기화하는 기능을 가진다.   

추가로 `커넥터`로 사용될 수 있도록 설계되었기 때문에 분산 모드 커넥트를 운영하고 있다면    
커넥트에서 미러메이커2 커넥터를 실행하여 토픽을 복제할 수 있다.     

## 미러메이커2를 활용한 단방향 토픽 복제  
미러메이커2를 사용하기 위해서는    
카프카 바이너리 디렉토리의 config 디렉토리에 포함된 `connect-mirror-maker.properties`를 수정해야한다.     
     
해당 파일에는 카프카 클러스터들에 대한 정보와 토픽 정보와 토픽을 복제하면서 사용할 내부 토픽에 대한 정보가 포함된다.         
여기서는 카프카 클러스터A(a-kafka:9092)와 카프카 클러스터B(b-kafka:9092)가 있을 경우를 가정한다.       
클러스터A에 존재하는 test라는 이름의 토픽을 클러스터B로 복제할 경우 다음과 같이 설정한다.     
  
**connect-mirror-maker.properties**   
```properties
clusters = A, B

A.bootstrap.servers = a-kafka:9092, A_host1:9092, A_host2:9092, A_host3:9092
B.bootstrap.servers = b-kafka:9092, B_host1:9092, B_host2:9092, B_host3:9092

A->B.enabled = true
A->B.topics = test

B->A.enabled = false
B->A.topics = .*

replication.factor=1

checkpoints.topic.replication.factor=1
heartbeats.topic.replication.factor=1
offset-syncs.topic.replication.factor=1
offset.storage.replication.factor=1
status.storage.replication.factor=1
config.storage.replication.factor=1
```



