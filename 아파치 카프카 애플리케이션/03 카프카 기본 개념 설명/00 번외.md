# 카프카 스트림즈 

실시간으로 끊임없이 발생하는 데이터를 처리해야할 때 어떤 프레임워크로 처리해야할지 고민이된다.   

* apache hadoop
* apache spark
* apahce strom
* cassandra
* R

여러 프레임워크가 존재하는데, 엄청나게 효과적인 프레임워크가 하나 있는데 바로 ***카프카 스트림즈**다.   
  
카프카는 분산 이벤트 스트리밍 플랫폼으로써 프로듀서와 컨슈머를 통해 데이터를 보내고 가져와서 처리한다.      
카프카 스트림즈는 컨슈머를 사용해서 데이터를 처리하는 것보다 더 안전하고 빠르면서도 다양한 기능을 사용할 수 있는 기술이다.    

카프카 스트림즈는 카프카에서 공식적으로 제공해주는 자바 라이브러리이다.         
토픽에 있는 데이터를 낮은 지연과 함깨 빠른 속도로 데이터를 처리할 수 있다.     
라이버러리 형태로 제공되니까 JVM 기반언어(Java/Kotlin/Scala)에서 사용이 가능하며, 스프링/순수 애플리케이션에서 활용가능하다.     

**장점**
* 카프카와 완벽하게 호환된다.   
    * 대부분의 기업에서는 카프카를 이벤트 저장소로 사용하고 저장된 데이터를 스파크 또는 로그 스태시와 같은 툴로 활용했다.  
    * 하지만, 이런 외부 오픈소스 툴의 문제는 빠르게 발전하는 오픈소스 카프카의 버전에 따라오지 못한다.   
    * 반면, 스트림즈는 카프카가 릴리즈 될때마다 같이 릴리즈되므로 최신 카프카 기능과 완벽호환이 된다.  
    * 카프카의 보안이나 ACL 같은 것들이 붙어있더라도 완벽하게 호환되어 처리될 수 있고 성능 개선도 빠르게 이루어진다.  
    * 그리고 무엇보다도 유실이나 중복 처리되지 않고 딱 한번만 처리될 수 있는 기능을 가진다.(카프카와 연동하는 이벤트 프로세싱 도구중에 거의 유일하다.)    
    * 카프카를 사용하고 있고, 데이터를 안전하고 빠르게 처리하고 싶다면 스트림즈를 1순위로 고려해야한다.    
* 스케줄링 도구가 필요없다.
    * 카프카와 연동하는 스트림 프로세싱 툴로, 가장 많이 널리 사용되는 것은 스파크 스트림이다.   
    * 스파크 스트리밍 또는 스파크 구조적 스트림을 사용하면, 카프카와 연동하여 마이크로 배치처리하는 이벤트 데이터 애플리케이션을 만들 수 있다. 
    * 그런데 문제는 스파크를 운영하기 위해서는 yarn이나 mesos와 같이 클러스터 관리자 또는 리소스 매니저 같은 것들이 필요하다.  
    * 그리고 클러스터를 운영하기 위해 대규모 장비들도 구축해야한다.   
    * 반면에 스트림즈를 사용하면, 스케줄링 도구는 전혀 필요가 없다.  
    * 스트림즈 애플리케이션은 컨슈머 애플리케이션이나 WAS 애플리케이션을 배포하는 것처럼 원하는 만큼 배포하면 된다.  
    * 만약 적은 양의 데이터를 처리해야 한다면 2개 정도의 스트림즈 애플리케이션을 띄워서 운영하면 된다.  
    * 데이터를 많이 처리해야한다면 자연스럽게 스케일 아웃해서 10,20개 애플리케이션을 자연스럽게 배포하면 된다.  
* 스트림즈 DSL과 프로세서 API 제공 
    * 스트림즈를 구현하는 방법은 2가지이다.(스트림즈 DSL과 프로세서 API)    
    * 스트림즈 DSL은 이벤트 기반 데이터 처리를 할때 필요한 다양한 기능을 쩨공한다.(map, join, window)    
    * 프로세서 API는 스트림즈 DSL에서 없는 기능에 대해서 직접 구현하고 사용할 수 있도록 해준다.  
    * 스트림즈 DSL만이 제공하는 KStream, KTable, GlobalKTable 은 그 어디서도 볼 수 없는 독특한 스트림 처리 기능이다.  
    * 카프카를 스트림 데이터 처리뿐만 아니라, 대규모 Key:Value 저장소로도 사용할 수 있는 멋진 기능을 가지고 있다.  
* 자체적으로 로컬 상태저장소를 사용한다.  
    * 실시간으로 들어오는 데이터를 저장하는 방식은 크게 2가지이다.(비상태기반 처리, 상태기반 처리)  
    * Stateless라고 불리는 비상태기반 처리는 필터링이나 데이터를 변환하는 처리이다.  
    * 이런 비상태기반 처리는 데이터가 들어오는 족족이 바로 처리하고 프로듀스하면 되기 때문에 유실이나 중복이 발생할 염려가 적다.  
    * 그런데 문제는 상태 기반 처리는, 상태기반 처리를 직접 구현하려면 window, join, aggregation 과 같은 처리는처리는  
      이전 받았던 데이터를 프로세스가 메모리에 저장하고 있으면서 다음 데이터를 처리해야해서 어렵다.   
    * 이런 상태기반 분산 프로세스를 구현하는 것은 매우 허들이 높다.  
    * 이런 어려움을 극복하게 도와주는 것이 스트림즈다.  
    * 스트림즈는 이런 어려운 처리를 돕기 위해 로컬에 rocksdb를 사용해서 상태를 저장하고  
    * 이 상태에 대한 변환 정보는 카프카의 변경 로그(changelog) 토픽에 저장된다.   
    * 그래서 스트림즈를 사용하면 프로세스에 장애가 발생하더라도 그 상태가 모두 안전하게 저장되기 때문에  
    * 자연스럽게 장애 복구가 될 수 있다.   

```java
KStream<String, String> paymentStream = builder.stream("payment");
KStream<String, String> filteredStream = paymentStream.filter((key, value) -> key.equals("unknown"));
filteredStream.to("unknown-payment");
```
* payment 토픽에 있는 데이터중 Key값이 unknown 인 데이터를 뽑아 unknown-payment 토픽에 보낸다.    
* 컨슈머를 폴링하거나 프로듀서를 어렵게 구현할 필요가 없어졌다.   
* 이렇게 스트림즈 DSL이 제공하는 이벤트 기반 메서드를 사용하면 쉽게 구현할 수 있다.  

# 카프카 커넥트  
# 카프카 미러메이킹  
