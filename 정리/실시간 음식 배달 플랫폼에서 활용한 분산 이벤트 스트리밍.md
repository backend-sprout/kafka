# 실시간 음식 배달 플랫폼에서 활용한 분산 이벤트 스트리밍 

배달 플랫폼 서비스를 만들면서, 데이터 처리량이 많았다.     
이러한 데이터를 어떻게 잘 분산해서 다량으로 처리할 수 있을까에 대한 고민과 이에 대한 솔루션이다.     
 
배달이란 함은, 주문 이후 30분 이내로 배달이 끝나는데     
그 30분 이내의 배송에서 처리하는 모든 트랜잭션이 굉장히 압축적으로 일어난다.     
(주문, 배달원, 수락, 픽업, 전달, 완료)      

# 목차 
 
1. 데이터 수평확장 처리       
    1. 어떻게 하면 트래픽을 서버를 늘려서 처리할 수 있을까?    
2. 카프카, 카프카 스트림즈 
3. 배타적인 지역관리 UberH3 
4. 코드를 몰라도 이해 가능  
5. 딜리버리프로덕트실 구인증 
    1. 서버 개발, 프론트 개발, 데이터 사이언티스트, 데이터 분석, 프로덕트 매니저 다 구함   

## 우리는 실시간 음식 배달 플랫폼을 만들고 있습니다.  
 
1. 고객은 앱으로 음식을 주문     
2. 주문은 업소에 전달, 사장님은 주문을 접수     
3. 근처에 가장 적합한 배달원을 계산후 배차 권유  
4. 배달원은 배차를 수락 
5. 배달원이 업소에 도착할 시간에 맞춰 업소에 알림 
6. 배달원이 업송에 도착후 바로 음식을 픽업 
7. 배달원은 고객에게 음식을 전달 
8. 이후 반복 
   
배달을 트래킹하는 시스템이 필요하고,       
이 주문이 어느 배달원에게 가장 적합해야하는지에 대한 컴퓨팅 파워가 필요하다(최적화)    
이와 같은 이 지역에 대한 배달 인프라에 대한 지표를 꾸준히 산출해야한다.       

# 주문에 대한 트래킹 필요 
> 주문하고 특정 시간이상인 주문건에 대한 처리 

<img width="786" alt="image" src="https://user-images.githubusercontent.com/50267433/161373694-b3386c63-39e2-49f9-8273-d20d0cbb5e07.png">    
        
RDS 에는 주문과 관련된 테이블이 있을 것이고            
스케줄러를 통해서 문제가 있는 주문을 속아낼 수 있다.(배달 시간이 긴 경우)   
  
**쿼리를 정기적으로 실행**   
```sql 
select * from 주문 where (상태 = '배달중') AND (현재시간 - 시작시간 >= 30)
```

* 주문이 30분이 넘는 것들에 대해서 감지해야겠어라는 뜻 

# 주문을 배달원에게 배차 

<img width="786" alt="image" src="https://user-images.githubusercontent.com/50267433/161373922-d605a7c7-d21a-427b-9620-b94e6eb4b6a8.png">
  
1분에 한번씩 쿼리를 실행한다고 가정한다.     
  
**쿼리를 정기적으로 실행**   
* 주문 목록 
    * `select * from 주문 where (배차 되지 않는 상태)`   
* 라이더 목록 
    * `select * from where(배차 가능한)`   

# 지역 + 상태별 실시간 수 지표  

**쿼리를 정기적으로 실행**   
```sql
select 지역, 상태, count(*) from 주문 group by 지역, 상태 
``` 

하지만, 문제가 있음   
* 서버 한대가 모든 로직을 수행 

# 의식의 흐름에 따른 분산 처리1 

<img width="500" alt="image" src="https://user-images.githubusercontent.com/50267433/161374248-3e299c3e-993b-4e69-8ad8-86ac8bfa0e2e.png">
   
하나의 서버에서 수 많은 요청(데이터) 처리가 필요하다면       
우리는 병렬처리 즉, 멀티 쓰레드 방식으로 이러한 문제를 해결하려 한다.      
    
아니면, VM을 띄어서 서버마다 각각의 파티션을 처리하도록 할 수 있다.          
서버를 여럿 띄워서 특정 지역을 처리하라고 해도 된다.         
단, 이 같은 경우 100개의 지역이면 100개의 서버를 띄워야 하므로 이는 조금 힘든 방식이다.     

# 의식의 흐름에 따른 분산 처리2

<img width="1061" alt="image" src="https://user-images.githubusercontent.com/50267433/161374526-bde33b8e-6bc3-4fbf-a44d-e95cc0d35791.png">   

지역이란 파티션이 있고 파티션 키가 있다    

* Command Sender : 지역이 100개가 있다면 그 지역에 대한 데이터를 알 수 있는 서버이다.   
    * 1분에 한번씩 배치가 돌아서, 지역만 뽑아서 이를 큐에 넣는다.    
    * 100개의 이벤트를 매 분마다 큐에 전달하는 역할   
    * <img width="1221" alt="image" src="https://user-images.githubusercontent.com/50267433/161374943-5ea457ea-2818-4c7e-9089-c15c70d692ea.png"> 
* Command Reciever : 파티션별로 특정 트래킹을 할 수 있는 서버 
    * <img width="1221" alt="image" src="https://user-images.githubusercontent.com/50267433/161374988-0fabe43b-ddc6-4bf2-93f8-04418480aa70.png"> 
* Queue : 여러 리시버들이 붙었을 때, 큐가 적절하게 N개의 리시버 서버에 분산 처리를 진행한다.(메시지 큐나, SQS)       

하지만, 이 같은 방법도 아래와 같은 문제가 발생한다.  
1. **메세지 중복처리에 대한 문제가 발생한다.(최소 한번 전송을 하는데 중복이 발생할 수 있다, 10만번중 1~2번)**       
2. SQS 는 거의 순서를 지키지만, 순서를 지킨다는 보장은 없다.(퍼포먼스를 위한 제약이었다)    
3.   





















