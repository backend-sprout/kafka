# 컨슈머 오프셋 관리 

컨슈머의 동작 중 가장 핵심은 **오프셋 관리**이다.   
컨슈머는 카프카에 저장된 메시지를 꺼내오는 역할을 하기에   
**컨슈머가 메시지를 어디까지 가져왔는지를 표시하는 것은 매우 중요하다.**    
      
오프셋은 동작을 멈춘 후에 다음 데이터를 가져오는 역할도 맡고 있지만        
컨슈머에 문제가 발생한다면 새로운 컨슈머가 오프셋을 기준으로 작업을 이어가기 위함도 중요하다.         
  
## 오프셋이란?
카프카는 메시지의 위치를 나타내는 위치를 오프셋이라 부르며 숫자 형태로 나타낸다.                
컨슈머 그룹은 자신의 오프셋 정보를 카프카에서 가장 안전한 저장소인 토픽에 저장한다.          
즉, `__consumer_offsets` 토픽에 각 컨슈머 그룹별로 오프셋 위치 정보가 기록된다.     
(하나의 토픽에는 여러 컨슈머 그룹의 오프셋 위치가 기록될 수 있다는 의미이다.)    
      
[](#asd)  
   
컨슈머의 기본 동작을 나타낸 그림이다.     
컨슈머들은 지정된 토픽의 메시지를 읽어온 위치의 오프셋 정보를 `__consumer_offsets` 토픽에 기록한다.     
이때 컨슈머 그룹은 `컨슈머 그룹`, `토픽`, `파티션` 등의 내용을 통합해 기록한다.        
이후 컨슈머 그룹은 자신의 컨슈머의 변경이 발생한 경우 어디까지 읽었는지 추적할 수 있다.     
(오프셋 값은 컨슈머가 현재까지 읽은 위치가 아닌 다음에 읽어야 할 위치이다.)   
    
## `__consumer_offsets 토픽`
모든 컨슈머 그룹의 정보가 저장되는 `__consumer_offsets` 토픽은 아래와 같은 정보를 가진다   
    
* offsets.topic.num.partitions: 기본값 50
* offsets.topic.replication.factor: 기본값 3
     
내부 토픽이지만, 파티션 수와 리플리케이션 팩터수는         
브로커의 설정 파일인 `server.properties`에서 관리자가 원하는 값으로 변경할 수 있다.       
기본값으로도 충분하지만, 간혹 팩터수가 1로 설정되는 문제가 있을 수 있으니 이를 꼭 확인하고 변경하자.    

