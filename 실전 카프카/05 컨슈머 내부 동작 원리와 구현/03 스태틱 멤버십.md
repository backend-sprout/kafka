# 스태틱 멤버십
 
때론, 하드웨어 점검이나 소프트웨어 업데이트 등의 이유로      
관리자는 **컨슈머 그룹 내의 컨슈머들을 하나씩 순차적으로 재시작하고 싶을 경우가 있을 것이다.**     
하지만, 하트비트 주기 및 세션 타임아웃 등의 설정으로 인해      
하나의 컨슈머가 재시작될 땨마다 전체 리밸런싱이 일어나며,      
리밸런싱 작업이 일어나는 동안 컨슈머들은 일시 중지하므로 이는 매우 번거로운 일이다.     
    
컨슈머 그룹내에 소수의 컨슈머가 있다면 대수롭지 않게 넘어갈 수 있겠지만     
10개의 컨슈머가 있다면 최소 10번 이상의 리밸런싱이 발생하고 10번 이상의 컨슈머 일시 중지가 일어난다.     
그렇다면 컨슈머의 재시작으로 인해 리밸런싱이 일어나는 배경을 알아보자.       
  
일반적인 컨슈머 그룹 동작에서는 **각 컨슈머를 식별하기 위해 엔티티 ID를 부여하게 된다.**    
이렇게 생성된 ID들은 컨슈머 그룹내에서 임시로 사용되는 값이다.     
따라서 컨슈머의 설정 변경이나 소프트웨어 업데이트로 인해 컨슈머가 재시작되면,  
컨슈머 그룹 내의 동일한 컨슈머임에도 새로운 컨슈머로 인식해 새로운 엔티티 ID가 부여되고     
이로인해 컨슈머 그룹의 리밸런싱이 발생한 것이다.    

대용량 메시지들을 처리하는 컨슈머 그룹이라면 리밸런싱 동작으로 인해 원래 상태를 복구하는데 상당한 시간이 소요될 수 있다.  
따라서 카프카는 이러한 불필요한 리밸런싱을 방어하기 위해 카프카 2.3 부터 스태틱 멤버십이라는 개념을 도입했다.   
 
스태틱 멤버십이란, 컨슈머 그룹내에서 컨슈머가 재시작등으로 그룹에서 나갔다가 다시 합류하더라도 리밸런싱이 일어나지 않게 한다.         
즉, **컨슈머마다 인식할 수 있는 ID를 적용함으로써 다시 합류하더라도 그룹 코디네이터가 기존 구성원임을 인식할 수 있게 한다.**       
그뿐 아니라, 스태틱 멤버십 기능이 적용된 컨슈머는 그룹에서 떠날 때 그룹     
코디네이터네에게 알리지 않으므로 불필요한 리밸런싱도 발생하지 않는다.       

스태틱 멤버십이 적용된 경우, 한번의 컨슈머 재시작 작업을 가정하고 리밸런싱을 얼마나 줄일 수 있는지 확인해보자.    
기본적으로 컨슈머 그룹에서 컨슈머가 그룹에서 컨슈머가 떠날 때 리밸런싱이 일어나는데,    
스태틱 멤버십이 적용된 컨슈머는 그룹에서 떠날 때 그룹 코디네이터에게 알리지 않으므로 여기서 한 번의 리밸런싱을 회피할 수 있다.  
그리고 해당 컨슈머가 다시 합류할 때, 그룹 코디네이터가 컨슈머의 ID를 확인하고 리밸런싱이 일어나는데,      
이때도 기존 구성원임을 인지하므로 리밸런싱은 발생하지 않는다.       
이렇게 스태틱 멤버십을 적용하면 컨슈머 재시작시 총 두번의 불필요한 리밸런싱을 회피할 수 있다.    

스태틱 멤버십을 적용하기 위한 옵션은 의외로 간단하다.  
기본값이 null String인 `group.instance.id`만 설정하면 스태틱 멤버십이 적용되지만,     
아프카 카프카 버전이 2.3 이상이어야 한다는 점에 유의해야한다.     
 
그리고 이 `group.instance.id` 옵션에는 그룹 코디네이터가         
컨슈머를 식별하기 위해 컨슈머 인스턴스별로 고유한 값을 입력해야한다.       
(접두어 접미어를 사용해도 된다, consumer-hostname1) 
  
만약 스태틱 멤버십 기능을 적용한다면, `session.timeout.ms`를 기본값보다는 큰 값으로 정해야한다.     
컨슈머를 재시작한 후 `session.timeout.ms` 값에 지정된 시간 동안 그룹 코디네이터가     
하트비트를 받지 못한다면 강제로 리밸런싱이 일어나므로,       
불필요한 리밸런싱 동작을 최소화하기 위한 스태틱 멤버십의 목적에 위배되기 때문이다.      
따라서 컨슈머의 재시작 시간을 고려해서 적절한 시간값으로 조정해둬야 한다.    
예를 들어, 컨슈머 재시작 시간이 총 2분 소요된다면       
기존 값에 2분보다 큰값으로 설정해야 불필요한 리밸런싱 동작을 사전에 방지할 수 있다.    

# 실습 

  
  



