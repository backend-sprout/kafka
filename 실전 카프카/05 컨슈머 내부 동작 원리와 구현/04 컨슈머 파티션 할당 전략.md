# 컨슈머 파티션 할당 전략

프로듀서의 파티셔너는 레코드를 토픽의 어느 파티션으로 전송할지를 결정하는 역할을 했다.      
컨슈머의 동작에서도 이와 유사하게 대상 토픽의 어느 파티션으로부터 레코드를 읽어올지를 결정한다.     
컨슈머 그룹의 리더 컨슈머가 정해진 파티션 할당 전략에 따라 각 컨슈머와 대상 토픽의 파티션을 매칭한다.    
  
파티션 할당 전략은 컨슈머 옵션의 `partition.assignment.strategy`로 표시하며 아래와 같은 전략이 있다.       

* RageAssignor(레인지 전략)
* RoundRobinAssignor(라운드 로빈 전략),   
* StickyAssignor(스티키 전략)
* CooperativeStickyAssignor(협력적 스티키 전략)

|파티션 할당 전략|설명|
|------------|---|
|레인지 파티션 할당 전략|파티션 할당 전략의 기본값으로서, 토픽별로 할당 전략을 사용한다<br>동일한 키를 이용하는 2개 이상의 토픽을 컨슘할 때 유용하다.|
|라운드 로빈 파티션 할당 전략|사용 가능한 파티션과 컨슈머들을 라운드 로빈으로 할당한다.<br>균등한 분배가 가능하다.|
|스티키 파티션 할당 전략|컨슈머가 컨슘하고 있는 파티션을 계속 유지할 수 있다.|
|협력적 스티키 파티션 할당 전략|스티키 방식과 유사하지만,<br>전체 일시 정지가 아닌 연속적인 재조정 방식|

## 레인지 파티션 할당 전략 

레인지 파티션 할당 전략인 RageAssignor는 파티션 할당 전략 중 기본값으로서, 각 토픽별로 할당 전략을 사용하게된다.     
레인지 파티션 할당 전략은 **먼저 구독하는 토픽에 대한 파티션을 순서대로 나열한 후 컨슈머를 순서대로 정렬한다.**       
이후, 각 컨슈머가 몇 개의 파티션을 할당해야하는지 전체 파티션 수를 컨슈머 수로 나눈다.   
컨슈머 수와 파티션 수가 일치하면 균등하게 할당될 수 있지만,     
균등하게 나눠지지 않는 경우에는 앞쪽의 컨슈머들은 추가 파티션을 할당받게된다.  

[](#)
    
이처럼, 불균등한 파티션 할당 전략은 왜 이용할까?       
레인지 파티션 할당 전략은 **동일한 레코드 키(메시지 키)를 사용**하고 있고         
**하나의 컨슈머 그룹이 동일한 파티션 수를 가진 2개 이상의 토픽을 컨슘할 때 유용하다.**      

사례 다시 공부,  
 
레인지 파티션 할당 전략은 방금 설명한  특수한 환경에서 사용하는 것이 좋지만,      
컨슈머에 균등하게 파티션이 분배되지 않으므로 컨슈머 그룹은 불균형한 상태로 운영할 수 있다는 점에 유의해야한다.  

## 라운드 로빈 파티션 전략 

라운드 로빈 파티션 할당 전략은 파티션 할당 전략 중 가장 간단한 할당 방식이다.   
먼저 컨슘해야하는 모든 파티션과 컨슈머 그룹 내 모든 컨슈머를 나열한 후,    
라운드 로빈으로 하나씩 파티션과 컨슈머를 할당하는 전략이다.     

[](#)  

위 그림에서 볼 수 있듯이 라운드 로빈 파티션 할당 전략은 먼저 구독 대상 토픽의 전체 파티션을 나열한다.     
파티션을 모두 나열한 다음에는 전체 컨슈머들도 나열한다.     
그리고 나열된 파티션을 컨슈머들과 하나씩 라운드 로빈 방식으로 일대일 매핑해나간다.       
 
순서대로 나열된 파티션들에는 차례대로 먼저 컨슈머1이 매핑되고 그다음 파티션은 컨슈머2가 매핑되는 방식으로     
순차적으로 컨슈머들이 바뀌어가면서 매핑되는 것을 알 수 있다.     
  
따라서 레인지 파티션 할당 전략에 비해 라운드 로빈 파티션 할당 전략 쪽이 파티션과 컨슈머를 더욱 균등하게 매핑한다.    

## 스티키 파티션 할당 전략 

만약 컨슈머 그룹의 리밸런싱 동작으로 인해 파티션이 재할당 된다면 어떤 상황이 벌어질까?     
레인지 파티션 할당 전략과, 라운드 로빈 파티션 할당 전략 모두 파티션 재할당 작업이 발생하면        
기존에 매핑되었던 파티션과 동일한 컨슈머가 다시 매핑되리라고는 보정할 수 없다.    
  
따라서 이러한 재할당 작업이 발생하더라도    
기존에 매핑됐던 파티션과 컨슈머를 최대한 유지하려고 하는 전략이 바로 스티키 파티션 할당 전략이다.  

스티키 파티션 할당 전략은 2가지 목적으로 컨슈머에 파티션을 할당한다.    
  
1. 가능한 균형 잡힌 파티션 할당     
2. 재할당이 발생할 때 되도록 기존의 할당된 파티션 정보를 보장하는 것이다.(우선 순위 높다)   
  
스티키 파티션 할당 전략이라고 해서 무조건 기존의 파티션과 컨슈머를 유지하지는 않는다.  
최대한 컨슈머를 균등하게 분배하는 것을 우선해야하고   
일부 파티션은 기존의 컨슈머와 매핑을 유지하지 못하고 새로운 컨슈머와 연결될 수 있다.  

[](#) 

위 그림에서 볼 수 있듯이, 스티키 파티션 할당 전략에서 최초의 배치 전략은 라운드 로빈 할당 전략과 매우 유사하다.      
하지만, 리밸런싱이 일어났을 때와 비교하면 스티키 파티션 할당 전략은 라운드 로빈 할당 전략과 확연한 차이가 있다.    

컨슈머2에서 문제가 발생하면 컨슈머2는 컨슈머 그룹에서 나가게된다.   
그러면 컨슈머 그룹에서는 리밸런싱이 일어난다.   

[](#)  

라운드 로빈에서는 아래와 같은 과정이 발생한다.  

1. 컨슈머2가 컨슈머 그룹에서 떠난다.  
2. 리밸런싱 동작이 일어난다.  
3. 모든 파티션을 순서대로 배치
4. 모든 컨슈머를 순서대로 배치 
5. 라운드 로빈 파티션 할당 전략에 맞춰 매핑 

열심히 일하던 컨슈머1과 컨슈머3에 할당됐던 파티션 연결은 끊기고      
컨슈머 그룹의 리밸런싱으로 인해 새로운 라티션이 할당되는 일이 발생했다.  

[](#) 

스티키 파티션 할당 전략을 사용하면, 기존 할당된 파티션은 그대로 유지하되     
장애가 발생한 컨슈머의 파티션들이 남은 컨슈머에 각각 할당 된 것을 볼 수 있다.  

스티키 파티션 전략이 이렇게 이상적으로 동작하는 이유는 다음과 같은 규칙에 따라 재할당을 하기 때문이다.   
    
* 컨슈머들의 최대 할당된 파티션의 수의 차이는 1  
* 기존에 존재하는 파티션 할당은 최대한 유지    
* 재할당 동작시, 유효하지 않은 모든 파티션 할당은 제거함   
* 할당되지 않은 파티션들은 균형을 맞추는 방법으로 컨슈머들에 할당한다.  
  
스티키 파티션 할당 전략은 최대한 컨슈머들의 균형을 맞추고      
기존 컨슈머에 할당된 파티션을 최대한 유지함으로써 컨슈머에 새로 할당하는 파티션 수를 최소화한다.     
이렇게 최소한의 움직임으로 컨슈머를 할당할 수 있으므로 라운드 로빈 할당 전략보다 효율적이다.    

## 협력적 스티키 파티션 할당 전략 
  
협력적 스티키 파티션 할당 전략은 결과적으로 본다면 방금 설명한 스티키 전략과 동일한 방식이다.      
즉 리밸런싱이 일어나도 기존의 컨슈머와 파티션 매핑은 유지하고 최소한의 파티션만 컨슈머와 매핑한다.       
다만 협력적 스티키 파티션 할당 전략과 한가지 차이가 있는데, **바로 컨슈머 그룹 내부의 리밸런싱 동작이 한층 더 고도화됐다는 점이다.**   
     
지금까지의 컨슈머 리밸런싱 동작에서는 내부적으로 EAGER라는 리밸런스 프로토콜을 사용했고,                
EAGER 프로토콜은 컨슈머 리밸런싱 동작 시 컨슈머에 할당된 모든 파티션을 항상 취소했다.              
이렇게 리밸런싱 동작에서 모든 파티션을 항상 취소하는 이유로는 다음과 같이 2가지를 꼽을 수 있다.         

1. 컨슈머들의 파티션 소유권 변경 때문이다.   
2. 






