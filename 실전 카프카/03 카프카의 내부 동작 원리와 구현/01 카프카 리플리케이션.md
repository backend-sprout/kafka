# 카프카 리플리케이션 
  
고가용성 분산 스트리밍 플랫폼인 카프카는 무수히 많은 데이터 파이프라인의 정중앙에 위치하는 **메인 허브 역할을 한다.**        

![9961CF3C5C0FBA462C](https://user-images.githubusercontent.com/50267433/150273392-d8e9d94b-2ed8-498f-a458-d348e65f1e98.png)
  
중앙에서 메인 허브 역할을 하는 카프카 클러스터가 어떠한 문제로 인해 정상적으로 동작하지 못한다면         
카프카의 연결된 전체 데이터 파이프라인에 영향을 미치게되므로 이는 매우 심각한 문제가 아닐 수 없다.     
     
따라서 카프카는 초기 설계 단계에서부터 장애가 발생하더라도   
중앙 데이터 허브로서 언정적인 서비스가 운영될 수 있도록 설계가 되어있다.      
  
대표적인 기술 중 하나로 안정성을 확보하기 위해 카프카 내부에서는 리플리케이션이 기능을 지원한다.     

# 리플리케이션 동작 개요 

카프카는 브로커의 장애에도 불구하고 연속적으로 안정적인 서비스를 제공함으로써 데이터 유실을 방지하여 유연성을 제공한다.     
카프카의 리플리케이션 동작을 위해 토픽 생성시 **필숫값** 으로, `replication factor` 옵션을 설정하도록 되어있다.   

## 간단 실습 

설치한 브로커 서버 중 한대로 접근을 해서 리플리케이션 토픽을 하나 생성해보려 한다.(peter-kafka01)   

* 토픽 이름 : peter-test01
* 파티션 수 : 1
* 리플리케이션 팩터 수 : 3

```console
/usr/local/kafka/bin/kafka-topics.sh --bootstrap-server peter-kafka01.foo.bar:9092 \
--create \
--topic peter-test01 \
--partitions 1 \
--replication-factor 3

Created topic peter-test01
```
위와 같이 명령어 실행 후, 생성된 토픽의 정보를 알기 위해서 `describe` 명령어를 사용할 수 있다.   

```cosole
/usr/local/kafka/bin/kafka-topics.sh --bootstrap-server peter-kafka01.foo.bar:9092 \
--topic peter-test01 \
--describe

Topic: peter-test01 PartitionCount: 1 ReplicationFactor: 3 Configs: segment.bytes=1073741824 
Topic: peter-test01 Partition: 0 Leader: 1 Replicas: 1,2,3 Isr: 1,2,3
```
* 1줄 : 
    * 토픽의 파티션 수인1과 리플리케이션 펙터(토픽) 수인 3이 표시되어있다.      
* 2줄 : 
    * 파티션0에 대한 내용이다.   
    * 파티션0의 리더는 브로커1이다.(리플리케이션중 1번)  
    * 리플리케이션들은 현재 3개가 있음을 나타낸다.(현재 동기화하고 있는 리플리케이션들은 브로커 1,2,3이라는 의미)      
    * 여기서 중요한 사실은 실제로 리플리케이션되는 것은 토픽이 아니라 토픽을 구성하는 파티션들이다.  

```console
/usr/local/kafka/bin/kafka-console-producer.sh --boot-server peter-kafka01.foo.bar:9092 \
--topic peter-test

> test message1
```
콘솔 프로듀서를 이용해 `test message1` 이라는 메시지를 `peter-test01` 이라는 토픽으로 전송했다.     
메시지를 보내고난 후, 세그먼트 파일에 저장되어있는지 살펴보자   

```console
/usr/local/kafka/bin/kafka-dump-log.sh \  
--print-data-log--files /data/kafka-logs/peter-test01-0/00000000000000000000.log
```
```
Dumping /data/kafka-logs/peter-test01-0/00000000000000000000.log  
Starting offset: 0
baseOffset: 0 lastOffset: 0 count: 1 baseSequence: -1 lastSequence: -1 produerId: -1 
producerEpch: -1 partitionLeaderEpoch: 0 isTransactional: false isControl: false
position: 0 CreateTime: 161008070323 size 81 magic: 2 compresscodec: NONE   
crc: 3417270022 isvalid: true
| offset: 0 CreateTime: 161008070323 ketysize: -1 valuesize: 13 sequence: -1   
headerKeys[] payload: test message1
```





