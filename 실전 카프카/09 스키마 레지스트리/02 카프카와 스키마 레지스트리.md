# 카프카와 스키마 레지스트리
 
카프카 스키마를 활용한다면      
관리자는 데이터처리시 유연성을 확보할 수 있으며 불필요한 커뮤니케이션 비용도 줄일 수 있다.        
카프카에서 스키마를 활용하는 방법과 스키마 레지스트리에 가장 최적화된 **에이브로 활용에 대해서 알아보자**   

## 스키마 레지스트리 개요  

카프카에서 스키마를 활용하는 방법은   
스키마 레지스트리라는 별도의 애플리케이션을 활용하는 것이다.   

* 스키마 레지스트리 : 스키마를 등록하고 관리하는 애플리케이션(컨플루언트 커뮤니티 라이선스 - 상업 비용)  

[#](#) 

스키마 레지스트리라는 카프카와 별도로 구성된 독립적 애플리케이션으로서    
카프카로 메시지를 전송하는 프로듀서와 직접 통신하며 카프카로부터 메시지를 꺼네오는 컨슈머와도 직접 통신한다.   
  
클라이언트들이 스키 정보를 사용하기 위해서는       
**프로듀서, 컨슈머, 스키마 레지스트리간에 직접 통신이 이뤄줘야한다.**     
   
* 프로듀서 : 스키마 레지스트리에 스키마를 등록  
* 스키마 레지스트리 : 프로듀서에 의해 등록된 스키마 정보를 카프카의 내부 토픽에 저장
* 프로듀서 : 스키마 레지스트리에 등록된 스키마의 ID와 메시지를 카프카로 전송
* 컨슈머 : 스키마 ID 를 스키마 레지스트리로부터 읽어온 후 프로듀서가 전송한 스키마 ID와 메시지를 조합해 읽는다.  

스키마 레지스트리를 이용하기 위해서는    
스키마 레지스트리가 지원하는 데이터 포맷을 사용해야하는데, 대표적인게 에이브로이다.  

## 스키마 레지스트리의 에이브로 지원 

**에이브로(Avro)**   
* 시스템, 프로그래밍 언어, 프로세싱 프레임워크 사이에서 데이터 교환을 도와주는 오픈소스 직렬화 시스템   
* 빠른 바이너리 데이터 포맷을 지원하며 JSON 형태의 스키마를 정의할 수 있는 매우 간결한 데이터 포맷    
* 스키마 레지스트리는 에이브로 포맷을 지원하며 최근에는 JSON, 프로토콜 버퍼 포맷도 지원한다.   

**컨플루언트가 권장하는 포맷 == 에이브로**  
* 에이브로는 JSON과 매핑된다.   
* 에이브로는 매우 간결한 데이터 포맷이다.  
* JSON은 메시지마다 필드 네임들이 포함되어 전송되므로 효율이 떨어진다.   
* 에이브로는 바이너리 형태이므로 매우 빠르다.  

## 에이브로 예시 

* 학생 이름
* 속한 반

```avro
{"namespace": "student.avro",
 "type": "record",
 "doc": "This is an example of Avro.",
 "name": "Student",
 "fields": [
     {"name": "name", "type": "string", "doc": "Name of the student"},
     {"name": "class", "type": "int", "doc": "Class of the student"}
 ]
}
```

* namespace: 이름을 식별하는 문자열 
* type : 에이브로는 record, enums, arrays, maps 등을 지원하며, 여기서는 record 타입으로 정의  
* doc : 사용자들에게 스키마 정의에 대한 설명 제공(주석)    
* name : 레코드의 이름을 나타내는 문자열로서, 필숫값      
* fileds : JSON 배열로서, 필드들의 리스트를 뜻한다.   
* name : 필드 이름
    * type : boolean, int, long, string 등의 데이터 타입 정의 
    * doc : 사용자들에게 해당 필드의 의미 설명(주석) 
   
JSON과 달리 에이브로는 데이터 필드마다 데이터타입을 정의할 수 있고,      
doc 을 이용해 각 필드의 의미를 데이터를 사용하고자 하는 사용자들에게 정확하게 전달할 수 있다.  

## 에이브로 실습 

스키마 레지스트리 설치에 앞서 카프카 클러스터 설정 초기화 

```
cd kafka2/
cd chapter2/ansible_palybook
ansible-playbook -i hosts kafka.yml 
``` 

카프카가 잘 설치되지 않는다면   
각 브로커 서버에서 카프카 서비스를 모두 종료한 후 주키퍼부터 새로 설치 바람   

























*







