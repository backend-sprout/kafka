# 모니터링 시스템 구성
  
잘 갖춰진 모니터링 도구를 사용해 관리자가 카프카의 현재 상태를 정확하게 파악한다면,     
미랴에 일어날 이슈나 문제를 사전에 예측해 미리 조사할 수 있으며 장애도 빠르게 감지해 신속한 장애 처리가 가능할 것이다.    
이제부터, 오픈소스 기반의 카프카 모니터링 시스템을 직접 구성해보면서 카프카를 모니터링하는 방법을 살펴보자.  
     
카프카를 모니터링하는 방법은 여러가지가 있지만,           
그 중에서 대표적인 모니터링은 **애플리케이션 로그 분석**과 **JMX**를 이용해 브로커들의 매트릭 정보를 확인하는 방법이다.           
이제부터 카프카 애플리케이션 로그의 레벨과 이를 변경하는 방법을 알아보겠습니다.          

## 애플리케이션으로서 카프카의 로그 관리와 분석  
          
카프카는 **카프카 애플리케이션에서 발생하는 모든 로그를 브로커의 로컬 디스크에 기록하고 있다.**          
관리자는 이 **로그를 활용해 카프카의 현재 상태나 이상 징후등을 발견하거나 이상 증상 발생시 원인을 찾는다.**       
지금부터 카프카에서 제공하는 카프카 애플리케이션 로그란 무엇인지 알아보자   
   
카프카는 애플리케이션 로그 관리를 위해 자바 기반의 로깅 유틸리티인 `아파치 log4j` 를 이용한다.   
log4j는 애플리케이션의 레벨별로 로깅이 가능하며, 관리자는 로그의 레벨을 보고 상황의 심각성 등을 유추할 수 있다.   
 
|로그 레벨|설명|  
|------|---|  
|TRACE|DEBUG 보다 상세한 로그를 기록한다.|  
|DEBUG|내부 애플리케이션 상황에 대한 로그를 기록함(INFO 로그 레벨보다 상세한 로그 기록)|     
|INFO|로그 레벨의 기본값이며, 일반적인 정보 수준의 로그를 기록한다.|    
|WARN|INFO 로그 레벨보다 높은 개념으로, 경고 수준의 로그를 기록함|   
|ERROR|경고 수준을 넘어 런타임 에러나 예상하지 못한 에러 로그를 기록한다.|  
|FATAL|로그 레벨 중 최종 단계이며, 심각한 오류로 인한 애플리케이션 중지 등의 로그를 기록한다.|    

카프카 애플리케이션에는 여섯 가지의 로그 레벨이 있으며 이 중 INFO 로그 레벨이 카프카 애플리케이션 로그의 기본값이다.    
간혹 카프카의 이슈가 발생하면 관리자는 INFO 수준보다 상세한 로그를 확인하고 싶을 수 있는데 이런 경우 로그의 레벨 변경이 필요하다.     
    
관리자가 로그 레벨을 조정할 수 있을까?         
카프카에서 제공하는 log4j 의 설정 변경을 통해 관리자는 언제든지 로그 레벨을 변경할 수 있다.      
그럼 브로커에서 직접 로그 레벨을 변경한 후 어떻게 변화하는지 실습을 통해 알아보자.     
  
### 실습   
   
브로커 서버 중 peter-kafka01에 접속한 후 다음과 같이 리눅의 cat 명령어를 이용해 log4 파일 내용을 확인하다.  
  
```shell 
cat /usr/local/kafka/config/log4j.properties
```
```properties
... 중략 
log4j.logger.kafka=INFO
log4j.logger.org.apache.kafka=INFO.  
... 중략 
```

출력 내용 중, `log4j.logger.kafka`와 `log4j.logger.org.apache.kafka`에서 로그레벨이 INFO로 적용된 것을 알 수 있다.   
이 부분을 DEBUG 로 변경하면 그제서야 로그 레벨이 변경이 된다.     
이후, 카프카 애플리케이션을 재시작하면 이전과 달리 DEBUG 레벨의 로그까지 찍히는 것을 볼 수 있다.    
단, 주의점으로는 이러한 로그 레벨을 낮춘다면 쌓이는 로그도 많아지고 이로 인해 디스크 용량이 차는 경우가 많다.   
(/usr/local/kafka/logs/server.log 를 통해 로그 내용을 확인할 수 있다.)   
  
앞서 살펴본 log4j.properties 설정 파일에서 볼 수 있듯이,      
카프카는 log4j를 통해 카프카 애플리케이션의 여러 가지 로그 파일들을 관리함을 알 수 있다.       
 
|로그 파일 이름|설명|  
|server.log|브로커 설정 정보와 정보성 로그 등을 기록한다.<br>브로커를 재시작하는 경우 브로커 옵션 정보가 기록된다.|  
|state-change.log|컨트롤러로부터 받은 정보를 기록한다.|  
|kafka-request.log|클라이언트로부터 받은 정보를 기록한다.|  
|log-cleaner.log|로그 컴팩션 동작들을 기록한다.|  
|controller.log|컨트롤러 관련 정보를 기록한다.|   
|kafka-authorizer.log|인증과 고나련도니 정보를 기록한다.|   

이처럼 카프카에서는 log4j를 이용해 여러가지 로그 파일들을 기록하고 있다.       
따라서 관리자는 디버깅이나 오류 확인 및 분석등이 필요할 경우 로그 레벨을 변경할 수 있다.      
카프카의 오류나 장애가 감지되면 가장 먼저 할 일은 바로 로그 파일을 확인하는 것이다.      

## JMX 를 이용한 카프카 메트릭 모니터링 

카프카를 안정적으로 모니터링하기 위해서는 애플리케이션에서 발생하는 로그의 내용을 분석하는 것 뿐만 아니라,      
현재 카프카 클러스터의 상태 및 이상 유무를 한 눈에 빠르게 확인할 수 있어야한다.     

**JMX**는 자바로 만든 애플리케이션의 **모니터링을 위한 도구를 제공하는 자바 API**로서, MBean 이라는 객체로 표현된다.      
그리고 카프카는 JMX를 이용해 카프카의 주요 매트릭들을 그래프와 같은 형태로 한눈에 확인할 수 있다.   

JMX를 이용해 카프카의 주요 메트릭을 확인하려면 몇가지 준비 절차가 더 필요하다.   
먼저 **브로커에 JMX 포트를 오픈**한 다음에, JMX에서 제공하는 **메트릭 정보를 관리자가 GUI 형태로 볼 수 있도록 구성해야한다.**  
이번에는 프로메테우스랑 익스포터를 이용해 JMX 모니터링 시스템을 구성해보고자 한다.   

### 카프카 JMX 설정 방법  
카프카에서 JMX 를 설정할 수 있는 방법은 여러가지가 있지만,      
systemd의 환경 변수 옵션을 추가하는 방법으로 진행할 예정이다.    

```shell
cat /usr/local/kafka/config/jmx
```  











    




