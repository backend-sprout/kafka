# 04 정확히 한 번 전송 
       
데이터 처리나 가공 작업을 하는 대부분의 사람들은          
데이터 파이프라인에서 메시지 중복이나 손실이 발생하지 않기를 원한다.        
가장 이상적인 상황이라면 모든 메시지를 정확히 한번 처리해주기를 원한다.(은행)   
 
만약 메시지를 처리하는 애플리케이션에서     
`중복 없는 전송` 또는 `정확히 한 번 처리`하는 기능을 제공한다면, 이는 매우 반가운 일이다.     
많은 애플리케이션이 `정확히 한번 처리` 기능을 제공한다고는 하지만, 이를 구현하는 것은 굉장히 어려운 일이다.       
또 메세지를 처리하다 보면 예상하기 힘든 다양한 변수들이 발생할 수 있어서 여러 조건들이 붙기도 한다.    
 
앞서 카프카에서는 **멱등성 옵션을 이용해 중복없는 전송을 할 수 없다고 설명했다.**          
**하지만, 이 중복없는 전송 방식이 정확히 한 번 전송한다는 의미는 아니다.**         
**카프카에서 장확히 한번 전송은 트랜잭션과 같은 전체적인 프로세스 처리를 의미하며,**       
**중복없는 전송은 정확히 한 번 전송의 일부 기능이라 할 수 있다.**  
   
전체적인 프로세스를 관리하기 위해 카프카에서는      
정확히 한번 처리를 담당하는 별도의 프로세스가 있는데 **이를 트랜잭션 API라고 부른다.**       
그럼 카프카에서 정확히 한번 전송 방식이 어떻게 구현되는지 살펴보자.    

```
트랜잭션이란 데이터베이스와 같은 시스템에서 이루어지는 논리적인 작업 단위를 말한다.       
작업이 완전히 실행되지 않거나 중간에 작업이 실패하는 경우,    
전체 작업을 실패로 처리하여 데이터베이스의 데이터 무결성을 지켜준다.        
트랜잭션은 ACID 4가지 성질을 가진다.    
```  

## 디자인   
   
프로듀서가 카프카로 **정확히 한 번 방식**으로 메시지를 전송할 때,        
**프로듀서가 보내는 메시지들은 원자적으로 처리되어 전송에 성공하거나 실패하게 된다.**   

이런 프로듀서의 전송을 위해 카프카에는     
컨슈머 그룹 코디네이터와 동일한 개념으로        
**트랜잭션 코디네이터**라는 것이 서버측에 존재한다.     

트랜잭션 코디네이터의 역할을 **프로듀서에 의해 전송된 메시지를 관리하는 커밋 또는 중단 등을 표시한다.**    
카프카에서는 컨슈머 오프셋 관리를 위해 오프셋 정보를 카프카의 내부 토픽에 저장하는데,     
트랜잭션도 동일하게 **트랜잭션 로그를 카프카의 내부 토픽인 `__transactio_state`에 저장한다.**        
`__transactio_state`는 카프카의 내부 토픽이지만,    
이 역시 토픽이므로 파티션 수와 리플리케이션 팩터 수가 존재하며 **브로커의 설정을 통해 관리자가 설정할 수 있다.**       

**__transactio_state 설정값**   
  
* transaction.state.log.num.partition=50
* transaction.state.log.replication.factor=3

이 때, **프로듀서가 해당 토픽에 트랜잭션 로그를 직접 기록하는 것이 아님을 참고하자.**   
프로듀서는 트랜잭션과 관련 정보를 트랜잭션 코디네이터에 알리고,     
**모든 정보의 로그는 트랜잭션 코디네이터가 직접 기록한다.**      
    
정확히 한 번 전송을 이용해 전송된 메시지들이 카프카에 저장되면,     
카프카의 메시지를 다루는 `클라이언트들`은 **해당 메시지들이 정상적으로 커밋된 것인지 또는 실패한 것인지 식별할 수 있어야한다.**      
카프카에서는 이를 식별하기 위한 정보로서, **`컨트롤 메시지`라고 불리는 특별한 타입의 메시지가 추가로 사용된다.**     
 
컨트롤러 메시지는   
**페이로드에 애플리케이션 데이터(메시지의 벨류)를 포함하지 않으며**    
**애플리케이션들에게 노출되지도 않는다.**          
컨트롤러 메시지는 오직 브로커와 클라이언트 통신에서만 사용된다.     

## 프로듀서 예제 코드  

```java
```

1. 정확히 한번 전송을 위한 설정 
2. 프로듀서 트랜잭션 초기화 
3. 프로듀서 트랜잭션 시작 
4. 프로듀서 트랜잭션 중단 
5. 프로듀서 트랜잭션 커밋 













## 예제 코드 
## 단계별 동작  



