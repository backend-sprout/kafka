# 프로듀서의 배치 

카프카에서는 토픽의 처리량을 높이기 위한 방법으로 토픽을 파티션으로 나눠 처리하며     
카프카 클라이언트인 프로듀서에서는 처리량을 높이기 위해 배치 전송을 권장한다.     
따라서, 프로듀서에서는 카프카로 전송하기 전, 배치 전송을 위해 토픽의 파티션별로 레코드들을 잠시 보관하고 있다.    
  
[#](#)  
  
프로듀서는 배치 전송을 위해 다음과 같은 옵션들을 제공한다.    

* buffer.memory : 
    * 카프카로 메시지들을 전송하기 위해 담아두는 프로듀서의 버퍼 메모리 옵션이다.    
    * 위 그림의 가장 큰 점선 박스로 둘러쌓인 부분을 의미한다.   
    * 기본값은 32mb로 설정되어 있으며, 관리자는 필요에따라 설정값을 조정할 수 있다.   
* batch.size :
    * 배치 전송을 위해 메세지(레코드)를 묶는 단위를 설정하는 배치 크기 옵션이다.        
    * 위 그림의 토픽 하단의 점선 박스로 둘러쌓인 부분을 의미한다.     
    * 기본값은 16KB로 설정 되어 있으며, 관리자는 배치 크기를 더 높이거나 줄일 수 있다.  
* linger.ms : 
    * 배치 전송을 위해 버퍼 메모리에서 대기하는 메시지들의 최대 대기시간을 설정하는 옵션이다.  
    * 단위는 밀리초(ms)이며, 기본값은 0이다.      
    * 즉, 기본값으로 설정하면 배치 전송을 위해 기다리지 않고 메시지들이 즉시 전송된다.   

프로듀서의 배치 전송 방식은 **단건의 메시지를 전송하는 것이 아니라 한번의 다량의 메시지를 묶어서 전송하는 방법이다.**       
이러한 배치 전송은 **불필요한 I/O를 줄일 수 있어 매우 효율적**이며, 더불어 카프카의 요청 수를 줄여주는 효과도 있다.       
(1000개의 메시지를 보내면 1000번의 요청과 응답이 발생하지만, 100개를 배치로 설정하면 10회면 충분하다)    
    
하지만, **장점이 많다고 해서 무조건 배치 처리를 해야함나 하는 것은 아니다.**         
카프카를 사용하는 목적에 따라 **처리량을 높일지**, 아니면 **지연 없는 전송을 해야할지** 선택 해야한다.       
   
대량의 메시지 처리할 때 처리량을 높여야하는 경우라면,   
사용자는 효율적인 배치 전송을 위해 프로듀서의 설정을 변경해야한다.       
    
지연 없는 전송이 목표라면 사용자는 프로듀서의 배치 전송 관련 설정을 제거해야한다.      
즉, 처리량을 높이려면 batch.size 와 linger.ms의 값을 크게 설정하고     
지연 없는 전송이 목표라면 batch.size 와 linger.ms 의 값을 작게 설정해야한다.    
  
그렇다면 각각의 설정값은 어느선까지 맞추는게 좋을까?    
이 질문에 대한 답은 없다.   
     
프로듀서가 카프카로 전송하려는  
메시지 크기, 초당 메시지 전송 수, 네트워크 환경에 따른 전송 속도 등에 따라        
배치 효율성에 대한 결과가 다르게 나타나기 때문이다.   
따라서 사용자는 **먼저 전송 목표를 정하고 목적에 따라 프로듀서의 옵션값을 조금씩 조정해가면서 최적의 값을 찾아가는게 중요하다.**   

``` 
성능을 나타내는 용어로 처리량이나 지연시간을 많이들 사용하는데,         
처리량은 처리하는 작업의 양을 나타내고, 지연시간은 작업을 처리하는 데 소요되는 시간을 의미한다.        
따라서 처리량이 높아지면 지연시간이 길어지고, 반대로 처리량이 낮아지면 지연시간은 짧아진다.      
카프카 프로듀서를 사용하면서 지연시간에만 집중한다면 처리량이 낮아지고      
처리량에만 집중하면 지연시간이 길어지므로, 사전의 검증 작업을 통해 적당한 수치로 조정해야한다.   
```

단, 사용자가 프로듀서의 **높은 처리량을 목표로 배치 전송을 설정하는 경우 주의해야할 사항이 있다.**    
바로 **버퍼 메모리 크기가 충분히 커야한다는 점이다.**          
즉, `buffer.memory` 크기는 반드시 `batch.size`보다 커야 한다.      
    
예를 들어, 토픽A가 3개의 파티션을 갖고 있고 `batch.size`는 기본값인 16KB이라고 가정하겠다.       
그럼 프로듀서의 `buffer.memory`의 최소 크기는 `16KB * 3`이 되어야한다.      
프로듀서는 전송에 실패하면 재시도를 수행해야하는데,   
이러한 부분까지 고려한다면 버퍼 메모리는 `48KB` 보다 더 큰 값으로 지정해야한다.   
      
배치 전송과 더불어 압축 기능을 잘 사용한다면,           
프로듀서는 메시지들을 더욱 효율적으로 카프카로 전송할 수 있다.             
클라이언트를 포함해 카프카에서는 gzip, snappy, lz4, zstd 등의 압축 포멧을 지원한다.       
    
각 압축 포멧마다 특징이 있으므로     
사용자가 메시지 전송시 메시지들의 높은 압축률을 선호한다면 gzip, zstd 를 선택하는 것이 좋고,    
낮은 지연시간을 선호한다면 lz4, snappy를 선택하기를 추천한다.   

